{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_list humanize %}

{% block page_title %}{% trans 'Advertisement Management System' %}{% endblock %}

{% block extrastyle %}
{{ block.super }}
<!-- SimpleMDE Markdown 编辑器 CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde@1.11.2/dist/simplemde.min.css">
<style>
    /* 广告管理页面特定样式 */
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    .card-header {
        background-color: white;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding: 15px 20px;
        font-weight: 600;
    }
    .table th {
        font-weight: 600;
        color: #495057;
        white-space: nowrap; /* 防止表头文字换行 */
    }
    .table td {
        vertical-align: middle;
    }

    /* 特定列的样式优化 */
    .table th:nth-child(3), /* Ad Unit ID 列 */
    .table td:nth-child(3) {
        min-width: 120px; /* 设置最小宽度 */
        white-space: nowrap; /* 防止内容换行 */
    }

    /* 确保表格在小屏幕下的响应式显示 */
    .table-responsive {
        overflow-x: auto;
    }
    .ad-image {
        width: 80px;
        height: 45px;
        object-fit: cover;
        border-radius: 4px;
    }
    .ad-image-placeholder {
        width: 80px;
        height: 45px;
        background-color: #e9ecef;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6c757d;
        font-size: 20px;
    }
    .badge-status {
        padding: 5px 10px;
        border-radius: 20px;
        font-weight: 500;
    }
    .badge-active {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    .badge-inactive {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    .action-buttons .btn {
        padding: 5px 10px;
        font-size: 0.85rem;
    }
    .search-box {
        position: relative;
    }
    .search-box .form-control {
        padding-left: 35px;
        border-radius: 20px;
    }
    .search-box i {
        position: absolute;
        left: 12px;
        top: 10px;
        color: #6c757d;
    }
    .filter-dropdown {
        min-width: 200px;
    }

    /* 筛选按钮样式 - 使用统一的按钮系统 */
    .filter-dropdown .dropdown-item {
        padding: 8px 16px;
        color: #495057;
        transition: all 0.2s ease;
    }

    .filter-dropdown .dropdown-item:hover {
        background-color: #f8f9fa;
        color: #007bff;
    }

    .filter-dropdown .dropdown-item:active {
        background-color: #007bff;
        color: white;
    }

    /* 筛选按钮悬停效果 */
    .btn-outline-secondary:hover {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
    }

    .btn-outline-secondary:focus {
        box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
    }

    .pagination {
        margin-bottom: 0;
    }
    .pagination .page-link {
        color: #343a40;
        padding: 8px 15px;
    }
    .pagination .page-item.active .page-link {
        background-color: #343a40;
        border-color: #343a40;
    }
    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }
    .modal-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }
    .form-label {
        font-weight: 500;
    }
    .form-text {
        font-size: 0.85rem;
    }
    .preview-image {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        margin-top: 10px;
    }
    @media (max-width: 991.98px) {
        .sidebar {
            width: 70px;
            padding-top: 10px;
        }
        .sidebar-header {
            padding: 0 10px 10px;
        }
        .sidebar-header img {
            height: 30px;
        }
        .sidebar-header h4, .sidebar-header p {
            display: none;
        }
        .menu-item {
            padding: 10px;
            justify-content: center;
        }
        .menu-item i {
            margin-right: 0;
        }
        .menu-item span {
            display: none;
        }
        .content {
            margin-left: 70px;
        }
    }
    @media (max-width: 767.98px) {
        .sidebar {
            width: 0;
            padding: 0;
            overflow: hidden;
        }
        .content {
            margin-left: 0;
        }
        .mobile-toggle {
            display: block !important;
        }
    }

    /* 表格悬浮效果 - 按原型设计 */
    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* 模态框样式 - 按原型设计 */
    .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
    }

    .modal-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #e9ecef;
    }

    .form-label {
        font-weight: 500;
    }

    .form-text {
        font-size: 0.85rem;
    }

    .preview-image {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        margin-top: 10px;
    }
    
    /* 添加广告模态框样式 */
    #addAdvertisementModal .modal-content {
        border: none;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    #addAdvertisementModal .modal-header {
        border-radius: 10px 10px 0 0;
        padding: 15px 20px;
    }
    
    #addAdvertisementModal .modal-body {
        padding: 20px;
    }
    
    #addAdvertisementModal .modal-footer {
        border-radius: 0 0 10px 10px;
        padding: 15px 20px;
    }
    
    /* 表单控件样式 */
    .form-control, .form-select {
        border-radius: 5px;
        border: 1px solid #dee2e6;
        padding: 8px 12px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    /* 分页组件样式更新 */
    .pagination {
      margin-bottom: 0;
    }
    
    .pagination .page-item .page-link {
      border-radius: 4px;
      margin: 0 2px;
      color: #495057;
      border-color: #dee2e6;
      font-size: 0.875rem;
      padding: 0.25rem 0.5rem;
      box-shadow: none;
      min-width: 32px;
      text-align: center;
      background-color: #fff;
    }
    
    .pagination .page-item.active .page-link {
      background-color: #007bff;
      border-color: #007bff;
      color: white;
      font-weight: 500;
    }
    
    .pagination .page-item .page-link:hover {
      background-color: #e9ecef;
      border-color: #dee2e6;
      color: #007bff;
    }
    
    .pagination .page-item.disabled .page-link {
      color: #adb5bd;
      background-color: #f8f9fa;
      border-color: #dee2e6;
      pointer-events: none;
    }

    /* 卡片页脚样式更新 */
    .card-footer {
        background-color: #fff;
        border-top: 1px solid rgba(0,0,0,0.05);
        padding: 0.75rem 1.25rem;
    }
    
    /* 图标样式调整 */
    .page-link .fas {
        font-size: 0.75rem;
    }
    
    /* 隐藏原始的Django Admin操作选择器 */
    .actions {
        display: none;
    }
    
    /* 广告位标签 */
    .position-badge {
        background-color: #e9ecef;
        color: #495057;
        padding: 5px 10px;
        border-radius: 16px;
        font-size: 0.85rem;
        display: inline-block;
    }
    .header-badge {
        background-color: rgba(13, 110, 253, 0.1);
        color: #0d6efd;
    }
    .sidebar-badge {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
    }
    .game-between-badge {
        background-color: rgba(25, 135, 84, 0.1);
        color: #198754;
    }
    .footer-badge {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
    }

    /* 广告统计卡片样式 */
    .ad-stats {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }
    .stat-card {
        flex: 1;
        background-color: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        text-align: center;
    }
    .stat-card .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        font-size: 1.5rem;
    }
    .stat-card .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
    }
    .stat-card .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    .bg-purple {
        background-color: rgba(106, 17, 203, 0.1);
        color: #6a11cb;
    }
    .bg-blue {
        background-color: rgba(37, 117, 252, 0.1);
        color: #2575fc;
    }
    .bg-green {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
    }
    .bg-orange {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
    }

    /* Google AdSense 预览样式 */
    .google-ad-preview {
        background-color: #f8f9fa;
        border: 2px solid #4285F4;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
        text-align: center;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: visible;
    }
    .google-ad-preview::before {
        content: "Google AdSense";
        position: absolute;
        top: -10px;
        left: 10px;
        background-color: #4285F4;
        color: white;
        padding: 2px 8px;
        border-radius: 3px;
        font-size: 0.75rem;
        font-weight: 500;
        z-index: 10;
    }
    .google-ad-preview.header {
        height: 90px;
        min-height: 90px;
    }
    .google-ad-preview.sidebar {
        height: 250px;
        min-height: 250px;
        width: 300px;
        padding: 15px;
        position: relative;
        z-index: 10;
    }
    .google-ad-preview.interstitial {
        height: 320px;
        min-height: 320px;
    }

    /* 确保 Google 图标完整显示 */
    .google-ad-preview .fab.fa-google {
        font-size: 2rem !important;
        line-height: 1.2;
        display: block;
        margin-bottom: 0.5rem;
        color: #4285F4 !important;
    }

    /* 修复图标容器的显示问题 */
    .google-ad-preview .d-flex {
        height: 100%;
        width: 100%;
    }

    /* 确保文字和图标的垂直对齐 */
    .google-ad-preview .d-flex > div {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }

    /* 确保尺寸信息文字颜色为黑色 */
    .google-ad-preview p {
        color: #333 !important;
        font-weight: 500;
    }

    /* 特别针对 sidebar 广告预览的文字颜色 */
    .google-ad-preview.sidebar p {
        color: #333 !important;
        font-weight: 500;
    }

    /* Google AdSense 设置样式 */
    .google-ad-settings {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 15px;
    }

    /* 广告代码样式 */
    .google-ad-code {
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 300px;
        overflow-y: auto;
    }

    /* 广告代码显示样式 */
    .google-ad-code {
        font-family: 'Courier New', monospace;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        font-size: 0.85rem;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 300px;
        overflow-y: auto;
    }

    /* 选项卡样式 */
    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
    }
    .nav-tabs .nav-link.active {
        font-weight: 600;
    }

    /* Revenue Reports 筛选栏样式优化 - 按原型设计 */
    .revenue-filter-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .revenue-filter-container .btn-group {
        flex-shrink: 0;
    }

    .revenue-filter-container .btn-group .btn {
        white-space: nowrap;
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        height: 38px; /* 确保与输入框高度一致 */
    }

    .revenue-filter-container .input-group {
        max-width: 300px;
        flex-shrink: 0;
    }

    .revenue-filter-container .input-group .form-control {
        height: 38px; /* 确保与按钮高度一致 */
    }

    .revenue-filter-container .input-group .btn {
        height: 38px; /* 确保日历按钮与输入框高度一致 */
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* 响应式设计 */
    @media (max-width: 767.98px) {
        .ad-stats {
            flex-direction: column;
            gap: 10px;
        }
        .google-ad-preview.sidebar {
            width: 100%;
            max-width: 300px;
            margin: 0 auto 15px;
        }

        /* 移动端筛选栏优化 */
        .revenue-filter-container {
            flex-direction: column;
            align-items: stretch;
            gap: 0.75rem;
        }

        .revenue-filter-container .btn-group {
            width: 100%;
        }

        .revenue-filter-container .btn-group .btn {
            flex: 1;
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            height: auto;
        }

        .revenue-filter-container .input-group {
            max-width: 100%;
        }
    }

    @media (max-width: 575.98px) {
        .revenue-filter-container .btn-group .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.4rem;
        }
    }
</style>
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  {{ media }}
{% endblock %}

{% block content %}
  <!-- Google AdSense 账户连接状态 -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
          <img src="https://www.gstatic.com/adsense/autoads/0192d4db1cdd7e52d0e4a5a3fbd1944b_google_adsense_icon.svg" alt="Google AdSense" style="width: 40px; height: 40px; margin-right: 15px;">
          <div>
            <h5 class="mb-0">Google AdSense</h5>
            {% if adsense_connected %}
              <p class="text-success mb-0"><i class="fas fa-check-circle me-1"></i> {% trans 'Connected' %}</p>
            {% else %}
              <p class="text-warning mb-0"><i class="fas fa-exclamation-triangle me-1"></i> {% trans 'Not Connected' %}</p>
            {% endif %}
          </div>
        </div>
        <div>
          {% if adsense_connected %}
            <button class="btn btn-outline-primary" id="syncDataBtn"><i class="fas fa-sync-alt me-1"></i> {% trans 'Sync Data' %}</button>
          {% endif %}
          <button class="btn btn-outline-secondary {% if not adsense_connected %}ms-0{% else %}ms-2{% endif %}"><i class="fas fa-cog me-1"></i> {% trans 'Settings' %}</button>
        </div>
      </div>
      {% if adsense_connected %}
        <div class="alert alert-success mb-0">
          <i class="fas fa-check-circle me-2"></i> {{ adsense_message }}
          {% if valid_ads_count > 0 %}
            <br><small class="text-muted">{% blocktrans count counter=valid_ads_count %}{{ counter }} ad unit configured with AdSense.{% plural %}{{ counter }} ad units configured with AdSense.{% endblocktrans %}</small>
          {% endif %}
        </div>
      {% else %}
        <div class="alert alert-warning mb-0">
          <i class="fas fa-exclamation-triangle me-2"></i> {{ adsense_message }}
          <br><small class="text-muted">{% trans 'To get started, edit your ad units and add your Google AdSense Publisher ID.' %}</small>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- 广告统计卡片 -->
  <div class="ad-stats">
    <div class="stat-card">
      <div class="stat-icon bg-purple">
        <i class="fas fa-ad"></i>
      </div>
      <div class="stat-value" id="activeAdsCount">{{ cl.result_count }}</div>
      <div class="stat-label">{% trans 'Active Ad Units' %}</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon bg-green">
        <i class="fas fa-eye"></i>
      </div>
      <div class="stat-value" id="monthlyViews">0</div>
      <div class="stat-label">{% trans 'Monthly Views' %}</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon bg-blue">
        <i class="fas fa-mouse-pointer"></i>
      </div>
      <div class="stat-value" id="monthlyClicks">0</div>
      <div class="stat-label">{% trans 'Monthly Clicks' %}</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon" style="background-color: rgba(234, 67, 53, 0.1); color: #EA4335;">
        <i class="fas fa-dollar-sign"></i>
      </div>
      <div class="stat-value" id="monthlyRevenue">$0.00</div>
      <div class="stat-label">{% trans 'Monthly Revenue' %}</div>
    </div>
  </div>

  <!-- 广告管理选项卡 -->
  <div class="card mb-4">
    <div class="card-header p-0">
      <ul class="nav nav-tabs" id="adManagementTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="ad-units-tab" data-bs-toggle="tab" data-bs-target="#ad-units" type="button" role="tab" aria-controls="ad-units" aria-selected="true">
            <i class="fas fa-th-large me-1"></i> {% trans 'Ad Units' %}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ad-placements-tab" data-bs-toggle="tab" data-bs-target="#ad-placements" type="button" role="tab" aria-controls="ad-placements" aria-selected="false">
            <i class="fas fa-map-marker-alt me-1"></i> {% trans 'Ad Placements' %}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ad-reports-tab" data-bs-toggle="tab" data-bs-target="#ad-reports" type="button" role="tab" aria-controls="ad-reports" aria-selected="false">
            <i class="fas fa-chart-line me-1"></i> {% trans 'Revenue Reports' %}
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="ad-settings-tab" data-bs-toggle="tab" data-bs-target="#ad-settings" type="button" role="tab" aria-controls="ad-settings" aria-selected="false">
            <i class="fas fa-cog me-1"></i> {% trans 'Ad Settings' %}
          </button>
        </li>
      </ul>
    </div>
    <div class="card-body">
      <div class="tab-content" id="adManagementTabsContent">
        <!-- 广告单元选项卡 -->
        <div class="tab-pane fade show active" id="ad-units" role="tabpanel" aria-labelledby="ad-units-tab">

          <div class="row align-items-center mb-3">
            <div class="col-md-3 mb-3 mb-md-0">
              <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" placeholder="{% trans 'Search ad units...' %}" id="searchInput">
              </div>
            </div>
            <div class="col-md-7 mb-3 mb-md-0">
              <div class="d-flex flex-wrap">
                <div class="dropdown me-2 mb-2 mb-md-0">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="adTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-filter me-1"></i> {% trans 'Ad Type' %}
                  </button>
                  <ul class="dropdown-menu filter-dropdown" aria-labelledby="adTypeDropdown">
                    <li><a class="dropdown-item" href="?">{% trans 'All Types' %}</a></li>
                    <li><a class="dropdown-item" href="?ad_type__exact=display">{% trans 'Display Ad' %}</a></li>
                    <li><a class="dropdown-item" href="?ad_type__exact=text">{% trans 'Text Ad' %}</a></li>
                    <li><a class="dropdown-item" href="?ad_type__exact=native">{% trans 'Native Ad' %}</a></li>
                    <li><a class="dropdown-item" href="?ad_type__exact=interstitial">{% trans 'Interstitial Ad' %}</a></li>
                  </ul>
                </div>
                <div class="dropdown me-2 mb-2 mb-md-0">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="statusDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-sort me-1"></i> {% trans 'Status' %}
                  </button>
                  <ul class="dropdown-menu filter-dropdown" aria-labelledby="statusDropdown">
                    <li><a class="dropdown-item" href="?">{% trans 'All Status' %}</a></li>
                    <li><a class="dropdown-item" href="?is_active__exact=1">{% trans 'Active' %}</a></li>
                    <li><a class="dropdown-item" href="?is_active__exact=0">{% trans 'Paused' %}</a></li>
                  </ul>
                </div>
                <div class="dropdown mb-2 mb-md-0">
                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-sort-amount-down me-1"></i> {% trans 'Sort' %}
                  </button>
                  <ul class="dropdown-menu filter-dropdown" aria-labelledby="sortDropdown">
                    <li><a class="dropdown-item" href="?o=-created_at">{% trans 'Latest Added' %}</a></li>
                    <li><a class="dropdown-item" href="?o=-revenue">{% trans 'Highest Revenue' %}</a></li>
                    <li><a class="dropdown-item" href="?o=-ctr">{% trans 'Click Rate' %}</a></li>
                    <li><a class="dropdown-item" href="?o=name">{% trans 'Name A-Z' %}</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="col-md-2 text-md-end">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGoogleAdModal">
                <i class="fas fa-plus me-1"></i> {% trans 'Add Ad Unit' %}
              </button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead>
                <tr>
                  <th style="width: 60px;">#</th>
                  <th>{% trans 'Ad Unit Name' %}</th>
                  <th>{% trans 'Ad Unit ID' %}</th>
                  <th>{% trans 'Type' %}</th>
                  <th>{% trans 'Size' %}</th>
                  <th>{% trans 'Position' %}</th>
                  <th>{% trans 'Views' %}</th>
                  <th>{% trans 'CTR' %}</th>
                  <th>{% trans 'Revenue' %}</th>
                  <th>{% trans 'Status' %}</th>
                  <th style="width: 150px;">{% trans 'Actions' %}</th>
                </tr>
              </thead>
              <tbody>
                {% for result in cl.result_list %}
                  <tr>
                    <td>{{ forloop.counter }}</td>
                    <td>
                      <a href="{% url 'admin:games_advertisement_change' result.pk %}"><strong>{{ result.name }}</strong></a>
                    </td>
                    <td>
                      {% if result.adsense_unit_id %}
                        <small class="text-muted">{{ result.adsense_unit_id|truncatechars:15 }}</small>
                      {% else %}
                        <small class="text-muted">-</small>
                      {% endif %}
                    </td>
                    <td>{{ result.get_ad_type_display }}</td>
                    <td>{{ result.get_ad_size_display|truncatechars:15 }}</td>
                    <td>
                      {% if result.position == 'header' %}
                        <span class="position-badge header-badge">{% trans 'Page Header' %}</span>
                      {% elif result.position == 'sidebar' %}
                        <span class="position-badge sidebar-badge">{% trans 'Sidebar' %}</span>
                      {% elif result.position == 'game_between' %}
                        <span class="position-badge game-between-badge">{% trans 'Game Interstitial' %}</span>
                      {% elif result.position == 'footer' %}
                        <span class="position-badge footer-badge">{% trans 'Footer' %}</span>
                      {% endif %}
                    </td>
                    <td>{{ result.view_count|intcomma }}</td>
                    <td>{{ result.ctr|floatformat:1 }}%</td>
                    <td>${{ result.revenue|floatformat:2 }}</td>
                    <td>
                      <span class="badge badge-status {% if result.is_active %}badge-active{% else %}badge-inactive{% endif %} active-status-toggle" data-id="{{ result.pk }}" style="cursor: pointer;">
                        {% if result.is_active %}{% trans 'Active' %}{% else %}{% trans 'Paused' %}{% endif %}
                      </span>
                    </td>
                    <td class="action-buttons">
                      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editGoogleAdModal" data-id="{{ result.pk }}"><i class="fas fa-edit"></i></button>
                      <button class="btn btn-sm btn-outline-info" onclick="showAdCode({{ result.pk }})"><i class="fas fa-code"></i></button>
                      <button class="btn btn-sm btn-outline-danger toggleStatusBtn" data-id="{{ result.pk }}">
                        {% if result.is_active %}<i class="fas fa-pause"></i>{% else %}<i class="fas fa-play"></i>{% endif %}
                      </button>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="11" class="text-center py-4">
                      <div class="text-muted">
                        <i class="fas fa-ad fa-3x mb-3 opacity-50"></i>
                        <h5>{% trans 'No ad units found' %}</h5>
                        <p>{% trans 'No ad units match your current filters. Try adjusting your search criteria.' %}</p>
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGoogleAdModal">
                          <i class="fas fa-plus me-1"></i> {% trans 'Add First Ad Unit' %}
                        </button>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
              {% if cl.result_count == 0 %}
                {% trans 'No records found' %}
              {% elif cl.result_count == 1 %}
                {% trans 'Showing 1 record' %}
              {% else %}
                {% blocktrans with start=cl.paginator.page_range.start end=cl.paginator.page_range.stop total=cl.result_count page=cl.page_num per_page=cl.paginator.per_page %}Showing page {{ page }} of {{ total }} records ({{ per_page }} per page){% endblocktrans %}
              {% endif %}
            </div>
            {% if cl.paginator.num_pages > 1 %}
            <nav aria-label="{% trans 'Pagination' %}">
              <ul class="pagination">
                {% if cl.page_num > 1 %}
                  <li class="page-item">
                    <a class="page-link" href="?{% if cl.query %}q={{ cl.query|urlencode }}&{% endif %}{% for key, value in request.GET.items %}{% if key != 'p' and key != 'q' %}{{ key }}={{ value }}&{% endif %}{% endfor %}p={{ cl.page_num|add:'-1' }}" aria-label="{% trans 'Previous' %}">
                      <i class="fas fa-chevron-left"></i>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link" aria-label="{% trans 'Previous' %}">
                      <i class="fas fa-chevron-left"></i>
                    </span>
                  </li>
                {% endif %}

                {% for page_num in cl.paginator.page_range %}
                  {% if page_num == cl.page_num %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                  {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?{% if cl.query %}q={{ cl.query|urlencode }}&{% endif %}{% for key, value in request.GET.items %}{% if key != 'p' and key != 'q' %}{{ key }}={{ value }}&{% endif %}{% endfor %}p={{ page_num }}">{{ page_num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}

                {% if cl.page_num < cl.paginator.num_pages %}
                  <li class="page-item">
                    <a class="page-link" href="?{% if cl.query %}q={{ cl.query|urlencode }}&{% endif %}{% for key, value in request.GET.items %}{% if key != 'p' and key != 'q' %}{{ key }}={{ value }}&{% endif %}{% endfor %}p={{ cl.page_num|add:'1' }}" aria-label="{% trans 'Next' %}">
                      <i class="fas fa-chevron-right"></i>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link" aria-label="{% trans 'Next' %}">
                      <i class="fas fa-chevron-right"></i>
                    </span>
                  </li>
                {% endif %}
              </ul>
            </nav>
            {% endif %}
          </div>
        </div>

        <!-- 广告位置选项卡 -->
        <div class="tab-pane fade" id="ad-placements" role="tabpanel" aria-labelledby="ad-placements-tab">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">{% trans 'Ad Placement Management' %}</h5>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPlacementModal">
              <i class="fas fa-plus me-1"></i> {% trans 'Add Ad Placement' %}
            </button>
          </div>

          <div class="row">
            <div class="col-md-4 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">{% trans 'Page Header Banner' %}</h5>
                  <p class="card-text text-muted">{% trans 'Displayed at the top of all website pages' %}</p>
                  <div class="google-ad-preview header">
                    <div class="d-flex align-items-center justify-content-center h-100">
                      <div>
                        <i class="fab fa-google text-primary fa-2x mb-2"></i>
                        <p class="mb-0">728 x 90 {% trans 'pixels' %}</p>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="text-muted">{% trans 'Active ads' %}: 2</span>
                    <div>
                      <button class="btn btn-sm btn-outline-primary edit-placement-btn" data-placement="header" data-bs-toggle="modal" data-bs-target="#editPlacementModal"><i class="fas fa-edit"></i></button>
                      <button class="btn btn-sm btn-outline-info ms-1 show-placement-code-btn" data-placement="header"><i class="fas fa-code"></i></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">{% trans 'Sidebar Ad Space' %}</h5>
                  <p class="card-text text-muted">{% trans 'Displayed in the website sidebar area' %}</p>
                  <div class="google-ad-preview sidebar mx-auto">
                    <div class="d-flex align-items-center justify-content-center h-100">
                      <div>
                        <i class="fab fa-google text-primary fa-2x mb-2"></i>
                        <p class="mb-0">300 x 250 {% trans 'pixels' %}</p>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="text-muted">{% trans 'Active ads' %}: 3</span>
                    <div>
                      <button class="btn btn-sm btn-outline-primary edit-placement-btn" data-placement="sidebar" data-bs-toggle="modal" data-bs-target="#editPlacementModal"><i class="fas fa-edit"></i></button>
                      <button class="btn btn-sm btn-outline-info ms-1 show-placement-code-btn" data-placement="sidebar"><i class="fas fa-code"></i></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="card h-100">
                <div class="card-body">
                  <h5 class="card-title">{% trans 'Game Interstitial Ad' %}</h5>
                  <p class="card-text text-muted">{% trans 'Full-screen ads displayed during game loading or between games' %}</p>
                  <div class="google-ad-preview interstitial mx-auto">
                    <div class="d-flex align-items-center justify-content-center h-100">
                      <div>
                        <i class="fab fa-google text-primary fa-2x mb-2"></i>
                        <p class="mb-0">320 x 480 {% trans 'pixels' %}</p>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="text-muted">{% trans 'Active ads' %}: 1</span>
                    <div>
                      <button class="btn btn-sm btn-outline-primary edit-placement-btn" data-placement="game_between" data-bs-toggle="modal" data-bs-target="#editPlacementModal"><i class="fas fa-edit"></i></button>
                      <button class="btn btn-sm btn-outline-info ms-1 show-placement-code-btn" data-placement="game_between"><i class="fas fa-code"></i></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 收益报告选项卡 -->
        <div class="tab-pane fade" id="ad-reports" role="tabpanel" aria-labelledby="ad-reports-tab">
          <div class="row mb-3">
            <div class="col-md-6 mb-3 mb-md-0">
              <div class="revenue-filter-container">
                <div class="btn-group me-2">
                  <button type="button" class="btn btn-outline-secondary active">{% trans 'Today' %}</button>
                  <button type="button" class="btn btn-outline-secondary">{% trans 'Yesterday' %}</button>
                  <button type="button" class="btn btn-outline-secondary">{% trans 'This Week' %}</button>
                  <button type="button" class="btn btn-outline-secondary">{% trans 'This Month' %}</button>
                </div>
                <div class="input-group">
                  <input type="text" class="form-control" id="customDateRange" placeholder="{% trans 'Custom date range' %}" readonly>
                  <button class="btn btn-outline-secondary" type="button" id="dateRangeBtn"><i class="fas fa-calendar"></i></button>
                </div>
              </div>
            </div>
            <div class="col-md-6 text-md-end">
              <div class="btn-group">
                <button type="button" class="btn btn-outline-secondary"><i class="fas fa-download me-1"></i> {% trans 'Export Report' %}</button>
                <button type="button" class="btn btn-outline-secondary"><i class="fas fa-sync-alt me-1"></i> {% trans 'Refresh Data' %}</button>
              </div>
            </div>
          </div>

          <!-- 收益概览卡片 -->
          <div class="row mb-4">
            <div class="col-md-3 mb-3 mb-md-0">
              <div class="card h-100">
                <div class="card-body text-center">
                  <h6 class="text-muted mb-2">{% trans 'Estimated Revenue' %}</h6>
                  <h3 class="mb-0" id="reportRevenue">$0.00</h3>
                  <p class="text-success mb-0"><i class="fas fa-arrow-up me-1"></i> 0%</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
              <div class="card h-100">
                <div class="card-body text-center">
                  <h6 class="text-muted mb-2">{% trans 'Page Views' %}</h6>
                  <h3 class="mb-0" id="reportViews">0</h3>
                  <p class="text-success mb-0"><i class="fas fa-arrow-up me-1"></i> 0%</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
              <div class="card h-100">
                <div class="card-body text-center">
                  <h6 class="text-muted mb-2">{% trans 'Clicks' %}</h6>
                  <h3 class="mb-0" id="reportClicks">0</h3>
                  <p class="text-success mb-0"><i class="fas fa-arrow-up me-1"></i> 0%</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-3 mb-md-0">
              <div class="card h-100">
                <div class="card-body text-center">
                  <h6 class="text-muted mb-2">{% trans 'Click Rate (CTR)' %}</h6>
                  <h3 class="mb-0" id="reportCTR">0%</h3>
                  <p class="text-danger mb-0"><i class="fas fa-arrow-down me-1"></i> 0%</p>
                </div>
              </div>
            </div>
          </div>

          <!-- 收益图表 -->
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>{% trans 'Revenue Trend' %}</span>
              <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary active">{% trans 'Revenue' %}</button>
                <button type="button" class="btn btn-outline-secondary">{% trans 'Views' %}</button>
                <button type="button" class="btn btn-outline-secondary">{% trans 'Click Rate' %}</button>
              </div>
            </div>
            <div class="card-body">
              <div style="height: 300px; background-color: #f8f9fa; border-radius: 5px; display: flex; align-items: center; justify-content: center;">
                <div class="text-center">
                  <i class="fas fa-chart-line fa-3x text-secondary mb-3"></i>
                  <p class="mb-0">{% trans 'Revenue trend chart will be displayed here' %}</p>
                  <p class="text-muted">{% trans 'Automatically generated after connecting to Google AdSense API' %}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 广告设置选项卡 -->
        <div class="tab-pane fade" id="ad-settings" role="tabpanel" aria-labelledby="ad-settings-tab">
          <div class="google-ad-settings mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">{% trans 'Google AdSense Account Settings' %}</h5>
              <button class="btn btn-outline-primary btn-sm" id="editAdSenseBtn">
                <i class="fas fa-edit me-1"></i> {% trans 'Edit Settings' %}
              </button>
            </div>

            <!-- 显示模式 -->
            <div id="adsense-display-mode">
              <div class="row mb-3">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">{% trans 'AdSense Publisher ID' %}</label>
                    <div class="input-group" id="adsense-publisher-id-group">
                      <input type="text" class="form-control" value="{% if adsense_connected and adsense_publisher_id %}{{ adsense_publisher_id }}{% else %}ca-pub-XXXXXXXXXXXXXXXX{% endif %}" readonly id="adsense-publisher-id-input">
                      <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(this.previousElementSibling.value)" id="adsense-copy-btn" {% if not adsense_connected %}disabled{% endif %}><i class="fas fa-copy"></i></button>
                      {% if adsense_connected %}
                        <button class="btn btn-outline-primary" type="button" id="verify-adsense-btn" onclick="verifyAdSenseConnection()">
                          <i class="fas fa-check-circle me-1"></i> {% trans 'Verify Connection' %}
                        </button>
                      {% endif %}
                    </div>
                    <div class="form-text">{% trans 'This is your Google AdSense publisher ID' %}</div>
                    <!-- 验证状态显示 -->
                    <div id="verification-status" class="mt-2" style="display: none;">
                      <div class="alert alert-info" id="verification-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin me-2"></i> {% trans 'Verifying AdSense connection...' %}
                      </div>
                      <div class="alert alert-success" id="verification-success" style="display: none;">
                        <i class="fas fa-check-circle me-2"></i> <span id="verification-success-message"></span>
                      </div>
                      <div class="alert alert-danger" id="verification-error" style="display: none;">
                        <i class="fas fa-exclamation-triangle me-2"></i> <span id="verification-error-message"></span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label class="form-label">{% trans 'Account Status' %}</label>
                    <input type="text" class="form-control" value="{% if adsense_connected %}{% trans 'Verified' %}{% else %}{% trans 'Not Configured' %}{% endif %}" readonly id="account-status-input">
                    <div class="form-text" id="account-status-text">{% if adsense_connected %}{% trans 'Your AdSense account has been verified and is active' %}{% else %}{% trans 'Please configure your AdSense Publisher ID in your ad units' %}{% endif %}</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 编辑模式 -->
            <div id="adsense-edit-mode" style="display: none;">
              <form id="adsenseSettingsForm" method="post" action="{% url 'admin:update_adsense_settings' %}">
                {% csrf_token %}
                <div class="row mb-3">
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="global-adsense-publisher-id" class="form-label">{% trans 'Global AdSense Publisher ID' %}</label>
                      <input type="text" class="form-control" id="global-adsense-publisher-id" name="global_publisher_id"
                             value="{% if adsense_connected and adsense_publisher_id %}{{ adsense_publisher_id }}{% endif %}"
                             placeholder="ca-pub-XXXXXXXXXXXXXXXX">
                      <div class="form-text">{% trans 'This Publisher ID will be applied to all ad units that do not have a specific Publisher ID configured.' %}</div>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label class="form-label">{% trans 'Apply to Existing Units' %}</label>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="update-existing-units" name="update_existing" checked>
                        <label class="form-check-label" for="update-existing-units">
                          {% trans 'Update all existing ad units' %}
                        </label>
                      </div>
                      <div class="form-text">{% trans 'Check to update all existing ad units with this Publisher ID' %}</div>
                    </div>
                  </div>
                </div>

                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  {% trans 'Your Google AdSense Publisher ID can be found in your AdSense account dashboard. It starts with "ca-pub-" followed by 16 digits.' %}
                </div>

                <div class="d-flex justify-content-end gap-2">
                  <button type="button" class="btn btn-secondary" id="cancelAdSenseBtn">
                    <i class="fas fa-times me-1"></i> {% trans 'Cancel' %}
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> {% trans 'Save Settings' %}
                  </button>
                </div>
              </form>
            </div>

            <div class="mb-3" id="payment-info-section">
              <label class="form-label">{% trans 'Payment Information' %}</label>
              {% if adsense_connected %}
                <div class="alert alert-success" id="payment-success">
                  <i class="fas fa-check-circle me-2"></i> {% trans 'Your payment information has been set up. Next payment date: 2023-05-21' %}
                </div>
              {% else %}
                <div class="alert alert-warning" id="payment-warning">
                  <i class="fas fa-exclamation-triangle me-2"></i> {% trans 'Payment information will be available after configuring your AdSense Publisher ID in your ad units.' %}
                </div>
              {% endif %}
            </div>

            <div class="d-flex justify-content-end">
              <a href="https://www.google.com/adsense" target="_blank" class="btn btn-outline-primary">
                <i class="fas fa-external-link-alt me-1"></i> {% trans 'Visit AdSense Console' %}
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Google Ad Unit Modal -->
  <div class="modal fade" id="addGoogleAdModal" tabindex="-1" aria-labelledby="addGoogleAdModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addGoogleAdModalLabel">{% trans 'Add Google Ad Unit' %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="addGoogleAdForm" method="post" action="{% url 'admin:games_advertisement_add' %}">
          {% csrf_token %}
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>{% trans 'Create a new Google AdSense ad unit. You can configure advanced settings after creation.' %}
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="id_name" class="form-label">{% trans 'Ad Unit Name' %}</label>
                  <input type="text" name="name" class="form-control" id="id_name" required>
                  <div class="form-text">{% trans 'A descriptive name for this ad unit' %}</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="id_position" class="form-label">{% trans 'Position' %}</label>
                  <select name="position" class="form-select" id="id_position" required>
                    <option value="header">{% trans 'Header' %}</option>
                    <option value="sidebar">{% trans 'Sidebar' %}</option>
                    <option value="game_between">{% trans 'Between Games' %}</option>
                    <option value="footer">{% trans 'Footer' %}</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="id_ad_type" class="form-label">{% trans 'Ad Type' %}</label>
                  <select name="ad_type" class="form-select" id="id_ad_type">
                    <option value="display">{% trans 'Display Ad' %}</option>
                    <option value="text">{% trans 'Text Ad' %}</option>
                    <option value="native">{% trans 'Native Ad' %}</option>
                    <option value="interstitial">{% trans 'Interstitial Ad' %}</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="id_ad_size" class="form-label">{% trans 'Ad Size' %}</label>
                  <select name="ad_size" class="form-select" id="id_ad_size">
                    <option value="responsive">{% trans 'Responsive' %}</option>
                    <option value="728x90">728 x 90 (Leaderboard)</option>
                    <option value="300x250">300 x 250 (Medium Rectangle)</option>
                    <option value="320x50">320 x 50 (Mobile Banner)</option>
                    <option value="300x600">300 x 600 (Half Page)</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="id_adsense_unit_id" class="form-label">{% trans 'AdSense Unit ID' %}</label>
              <input type="text" name="adsense_unit_id" class="form-control" id="id_adsense_unit_id">
              <div class="form-text">{% trans 'Optional: Enter your Google AdSense unit ID' %}</div>
            </div>
            <div class="form-check form-switch">
              <input type="checkbox" name="is_active" class="form-check-input" id="id_is_active" checked>
              <label class="form-check-label" for="id_is_active">{% trans 'Active' %}</label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
            <button type="submit" class="btn btn-primary">{% trans 'Create Ad Unit' %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- 编辑Google广告单元模态框 -->
  <div class="modal fade" id="editGoogleAdModal" tabindex="-1" aria-labelledby="editGoogleAdModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editGoogleAdModalLabel">{% trans 'Edit Google Ad Unit' %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editGoogleAdForm" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editAdUnitName" class="form-label">{% trans 'Ad Unit Name' %}</label>
                <input type="text" class="form-control" id="editAdUnitName" name="name" required>
                <div class="form-text">{% trans 'A descriptive name for this ad unit' %}</div>
              </div>
              <div class="col-md-6">
                <label for="editAdUnitId" class="form-label">{% trans 'Ad Unit ID' %}</label>
                <input type="text" class="form-control" id="editAdUnitId" name="adsense_unit_id">
                <div class="form-text">{% trans 'Google AdSense unit ID (optional)' %}</div>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editAdUnitType" class="form-label">{% trans 'Ad Type' %}</label>
                <select class="form-select" id="editAdUnitType" name="ad_type">
                  <option value="display">{% trans 'Display Ad' %}</option>
                  <option value="text">{% trans 'Text Ad' %}</option>
                  <option value="native">{% trans 'Native Ad' %}</option>
                  <option value="interstitial">{% trans 'Interstitial Ad' %}</option>
                  <option value="video">{% trans 'Video Ad' %}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="editAdUnitSize" class="form-label">{% trans 'Ad Size' %}</label>
                <select class="form-select" id="editAdUnitSize" name="ad_size">
                  <option value="responsive">{% trans 'Responsive' %}</option>
                  <option value="728x90">728 x 90 (Leaderboard)</option>
                  <option value="300x250">300 x 250 (Medium Rectangle)</option>
                  <option value="320x50">320 x 50 (Mobile Banner)</option>
                  <option value="300x600">300 x 600 (Half Page)</option>
                  <option value="970x250">970 x 250 (Billboard)</option>
                  <option value="320x480">320 x 480 (Mobile Interstitial)</option>
                  <option value="custom">{% trans 'Custom Size' %}</option>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editAdUnitPosition" class="form-label">{% trans 'Ad Position' %}</label>
                <select class="form-select" id="editAdUnitPosition" name="position">
                  <option value="header">{% trans 'Page Header' %}</option>
                  <option value="sidebar">{% trans 'Sidebar' %}</option>
                  <option value="game_between">{% trans 'Game Interstitial' %}</option>
                  <option value="footer">{% trans 'Footer' %}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="editAdStatus" class="form-label">{% trans 'Ad Status' %}</label>
                <select class="form-select" id="editAdStatus" name="is_active">
                  <option value="1">{% trans 'Active' %}</option>
                  <option value="0">{% trans 'Paused' %}</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label for="editAdUrl" class="form-label">{% trans 'Advertisement URL' %}</label>
              <input type="url" class="form-control" id="editAdUrl" name="url" placeholder="https://example.com">
              <div class="form-text">{% trans 'Target URL when ad is clicked (optional)' %}</div>
            </div>
            <div class="mb-3">
              <label for="editAdHtmlCode" class="form-label">{% trans 'HTML Code' %}</label>
              <textarea class="form-control" id="editAdHtmlCode" name="html_code" rows="4" placeholder="{% trans 'Enter custom HTML code for the advertisement' %}"></textarea>
              <div class="form-text">{% trans 'Fill this field if using third-party advertisement code' %}</div>
            </div>
            <div class="mb-3">
              <label class="form-label">{% trans 'Ad Statistics' %}</label>
              <div class="row">
                <div class="col-md-4 mb-2">
                  <div class="card bg-light">
                    <div class="card-body py-2 text-center">
                      <h6 class="mb-0">{% trans 'Views' %}</h6>
                      <p class="mb-0 fs-4" id="editAdViews">0</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-2">
                  <div class="card bg-light">
                    <div class="card-body py-2 text-center">
                      <h6 class="mb-0">{% trans 'Clicks' %}</h6>
                      <p class="mb-0 fs-4" id="editAdClicks">0</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-4 mb-2">
                  <div class="card bg-light">
                    <div class="card-body py-2 text-center">
                      <h6 class="mb-0">{% trans 'CTR' %}</h6>
                      <p class="mb-0 fs-4" id="editAdCTR">0%</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
            <button type="submit" class="btn btn-primary">{% trans 'Save Changes' %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Ad Placement Modal -->
  <div class="modal fade" id="addPlacementModal" tabindex="-1" aria-labelledby="addPlacementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addPlacementModalLabel">{% trans 'Add Ad Placement' %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="addPlacementForm" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>{% trans 'Create a new ad placement position. This will define where ads can be displayed on your website.' %}
            </div>
            <div class="mb-3">
              <label for="placementName" class="form-label">{% trans 'Placement Name' %}</label>
              <input type="text" class="form-control" id="placementName" name="name" placeholder="{% trans 'Enter ad placement name' %}" required>
              <div class="form-text">{% trans 'A descriptive name for this ad placement' %}</div>
            </div>
            <div class="mb-3">
              <label for="placementDescription" class="form-label">{% trans 'Description' %}</label>
              <textarea class="form-control" id="placementDescription" name="description" rows="2" placeholder="{% trans 'Enter ad placement description' %}"></textarea>
              <div class="form-text">{% trans 'Brief description of where this ad will be displayed' %}</div>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="placementSize" class="form-label">{% trans 'Ad Size' %}</label>
                  <select class="form-select" id="placementSize" name="ad_size" required>
                    <option value="">{% trans 'Select Size' %}</option>
                    <option value="728x90">728 x 90 ({% trans 'Leaderboard' %})</option>
                    <option value="300x250">300 x 250 ({% trans 'Medium Rectangle' %})</option>
                    <option value="336x280">336 x 280 ({% trans 'Large Rectangle' %})</option>
                    <option value="320x100">320 x 100 ({% trans 'Large Mobile Banner' %})</option>
                    <option value="320x50">320 x 50 ({% trans 'Mobile Banner' %})</option>
                    <option value="responsive">{% trans 'Responsive' %}</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="placementPosition" class="form-label">{% trans 'Position' %}</label>
                  <select class="form-select" id="placementPosition" name="position" required>
                    <option value="">{% trans 'Select Position' %}</option>
                    <option value="header">{% trans 'Page Header' %}</option>
                    <option value="sidebar">{% trans 'Sidebar' %}</option>
                    <option value="game_between">{% trans 'Between Games' %}</option>
                    <option value="footer">{% trans 'Footer' %}</option>
                    <option value="content_top">{% trans 'Content Top' %}</option>
                    <option value="content_bottom">{% trans 'Content Bottom' %}</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label for="placementPages" class="form-label">{% trans 'Display Pages' %}</label>
              <select class="form-select" id="placementPages" name="display_pages" multiple style="height: 100px;">
                <option value="home">{% trans 'Homepage' %}</option>
                <option value="game_detail">{% trans 'Game Detail Page' %}</option>
                <option value="category">{% trans 'Category Pages' %}</option>
                <option value="profile">{% trans 'User Profile' %}</option>
                <option value="all" selected>{% trans 'All Pages' %}</option>
              </select>
              <div class="form-text">{% trans 'Hold Ctrl key to select multiple pages' %}</div>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="placementResponsive" name="is_responsive" checked>
              <label class="form-check-label" for="placementResponsive">{% trans 'Enable Responsive' %}</label>
              <div class="form-text">{% trans 'Automatically adjust ad size based on device screen size' %}</div>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="placementActive" name="is_active" checked>
              <label class="form-check-label" for="placementActive">{% trans 'Active' %}</label>
              <div class="form-text">{% trans 'Enable this ad placement immediately' %}</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
            <button type="submit" class="btn btn-primary">{% trans 'Add Placement' %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Show Ad Code Modal -->
  <div class="modal fade" id="adCodeModal" tabindex="-1" aria-labelledby="adCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="adCodeModalLabel">{% trans 'Ad Code' %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="google-ad-code" id="adCodeContent">
            <!-- Ad code will be displayed here -->
          </div>
          <div class="mt-3">
            <button class="btn btn-outline-primary" onclick="copyAdCode()">
              <i class="fas fa-copy me-1"></i> {% trans 'Copy Code' %}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 编辑广告位置模态框 -->
  <div class="modal fade" id="editPlacementModal" tabindex="-1" aria-labelledby="editPlacementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editPlacementModalLabel">{% trans 'Edit Ad Placement' %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="editPlacementForm" method="post">
          {% csrf_token %}
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>{% trans 'Configure the settings for this ad placement position.' %}
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editPlacementName" class="form-label">{% trans 'Placement Name' %}</label>
                <input type="text" class="form-control" id="editPlacementName" name="name" required>
                <div class="form-text">{% trans 'A descriptive name for this ad placement' %}</div>
              </div>
              <div class="col-md-6">
                <label for="editPlacementPosition" class="form-label">{% trans 'Position' %}</label>
                <select class="form-select" id="editPlacementPosition" name="position" required>
                  <option value="header">{% trans 'Page Header' %}</option>
                  <option value="sidebar">{% trans 'Sidebar' %}</option>
                  <option value="game_between">{% trans 'Game Interstitial' %}</option>
                  <option value="footer">{% trans 'Footer' %}</option>
                </select>
              </div>
            </div>
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="editPlacementSize" class="form-label">{% trans 'Ad Size' %}</label>
                <select class="form-select" id="editPlacementSize" name="ad_size" required>
                  <option value="728x90">728 x 90 ({% trans 'Leaderboard' %})</option>
                  <option value="300x250">300 x 250 ({% trans 'Medium Rectangle' %})</option>
                  <option value="320x480">320 x 480 ({% trans 'Mobile Interstitial' %})</option>
                  <option value="responsive">{% trans 'Responsive' %}</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="editPlacementMaxAds" class="form-label">{% trans 'Maximum Ads' %}</label>
                <input type="number" class="form-control" id="editPlacementMaxAds" name="max_ads" min="1" max="10" value="3">
                <div class="form-text">{% trans 'Maximum number of ads to display in this position' %}</div>
              </div>
            </div>
            <div class="mb-3">
              <label for="editPlacementDescription" class="form-label">{% trans 'Description' %}</label>
              <textarea class="form-control" id="editPlacementDescription" name="description" rows="2"></textarea>
              <div class="form-text">{% trans 'Brief description of where this ad will be displayed' %}</div>
            </div>
            <div class="form-check form-switch mb-3">
              <input type="checkbox" name="is_active" class="form-check-input" id="editPlacementActive" checked>
              <label class="form-check-label" for="editPlacementActive">{% trans 'Active' %}</label>
              <div class="form-text">{% trans 'Enable this ad placement' %}</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Cancel' %}</button>
            <button type="submit" class="btn btn-primary">{% trans 'Save Changes' %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Show Ad Placement Code Modal -->
  <div class="modal fade" id="placementCodeModal" tabindex="-1" aria-labelledby="placementCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="placementCodeModalLabel">{% trans 'Ad Placement Code' %}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>{% trans 'Use this code to display ads in the selected placement position.' %}
          </div>
          <div class="google-ad-code" id="placementCodeContent">
            <!-- Ad placement code will be displayed here -->
          </div>
          <div class="mt-3">
            <button class="btn btn-outline-primary" onclick="copyPlacementCode()">
              <i class="fas fa-copy me-1"></i> {% trans 'Copy Code' %}
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extrajs %}
  {{ block.super }}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // 筛选器状态管理
      const filterState = {
        timeFilter: 'Today', // 默认时间筛选器状态
        chartFilter: 'Revenue' // 默认图表筛选器状态
      };

      // 加载广告统计数据
      loadAdStatistics();

      // 同步数据按钮
      const syncDataBtn = document.getElementById('syncDataBtn');
      if (syncDataBtn) {
        syncDataBtn.addEventListener('click', function() {
          this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> {% trans "Syncing..." %}';
          this.disabled = true;

          // 模拟同步过程
          setTimeout(() => {
            loadAdStatistics();
            this.innerHTML = '<i class="fas fa-sync-alt me-1"></i> {% trans "Sync Data" %}';
            this.disabled = false;
            showToast('success', '{% trans "Data synchronized successfully" %}');
          }, 2000);
        });
      }

      // Settings按钮 - 切换到广告设置选项卡
      const settingsBtn = document.querySelector('.btn-outline-secondary:has(i.fa-cog)');
      if (settingsBtn) {
        settingsBtn.addEventListener('click', function() {
          // 切换到广告设置选项卡
          const adSettingsTab = document.getElementById('ad-settings-tab');
          if (adSettingsTab) {
            // 使用Bootstrap的tab API切换选项卡
            const tab = new bootstrap.Tab(adSettingsTab);
            tab.show();

            // 显示成功消息
            showToast('info', '{% trans "Switched to Ad Settings" %}');
          }
        });
      }
      
      // 加载广告统计数据
      function loadAdStatistics() {
        fetch('{% url "games:ad_statistics" %}', {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            if (data.status === 'success') {
              updateStatistics(data.data);
            } else {
              console.error('API returned error:', data.message);
            }
          })
          .catch(error => {
            console.error('Error loading statistics:', error);
            // 如果API调用失败，显示默认数据
            updateStatistics({
              active_ads: 3,
              total_views: 97284,
              total_clicks: 3152,
              total_revenue: 342.18,
              avg_ctr: 3.24
            });
          });
      }

      // 更新统计数据显示
      function updateStatistics(data) {
        const activeAdsEl = document.getElementById('activeAdsCount');
        const monthlyViewsEl = document.getElementById('monthlyViews');
        const monthlyClicksEl = document.getElementById('monthlyClicks');
        const monthlyRevenueEl = document.getElementById('monthlyRevenue');

        if (activeAdsEl) activeAdsEl.textContent = data.active_ads;
        if (monthlyViewsEl) monthlyViewsEl.textContent = formatNumber(data.total_views);
        if (monthlyClicksEl) monthlyClicksEl.textContent = formatNumber(data.total_clicks);
        if (monthlyRevenueEl) monthlyRevenueEl.textContent = '$' + data.total_revenue.toFixed(2);

        // 更新报告页面数据
        const reportRevenueEl = document.getElementById('reportRevenue');
        const reportViewsEl = document.getElementById('reportViews');
        const reportClicksEl = document.getElementById('reportClicks');
        const reportCTREl = document.getElementById('reportCTR');

        if (reportRevenueEl) reportRevenueEl.textContent = '$' + data.total_revenue.toFixed(2);
        if (reportViewsEl) reportViewsEl.textContent = formatNumber(data.total_views);
        if (reportClicksEl) reportClicksEl.textContent = formatNumber(data.total_clicks);
        if (reportCTREl) reportCTREl.textContent = data.avg_ctr.toFixed(1) + '%';
      }

      // Format number display
      function formatNumber(num) {
        if (num >= 1000000) {
          return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
          return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
      }

      // Search functionality
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const searchTerm = this.value.toLowerCase();
          const tableRows = document.querySelectorAll('#ad-units tbody tr');

          tableRows.forEach(row => {
            const adName = row.querySelector('td:nth-child(2)');
            if (adName) {
              const text = adName.textContent.toLowerCase();
              if (text.includes(searchTerm)) {
                row.style.display = '';
              } else {
                row.style.display = 'none';
              }
            }
          });
        });
      }

      // 筛选按钮功能增强
      function initializeFilterButtons() {
        // 为所有筛选下拉菜单项添加点击事件
        const filterItems = document.querySelectorAll('.filter-dropdown .dropdown-item');
        filterItems.forEach(item => {
          item.addEventListener('click', function(e) {
            e.preventDefault();

            // 获取筛选参数
            const href = this.getAttribute('href');
            const url = new URL(window.location.origin + href);
            const params = url.searchParams;

            // 更新按钮文本以显示当前筛选状态
            const dropdown = this.closest('.dropdown');
            const button = dropdown.querySelector('.dropdown-toggle');
            const icon = button.querySelector('i');
            const iconClass = icon.className;

            if (href === '?') {
              // 重置筛选
              button.innerHTML = `<i class="${iconClass}"></i> ${button.textContent.split(' ')[1]}`;
            } else {
              // 显示选中的筛选项
              button.innerHTML = `<i class="${iconClass}"></i> ${this.textContent}`;
            }

            // 导航到筛选URL
            window.location.href = href;
          });
        });
      }

      // 初始化筛选按钮
      initializeFilterButtons();

      // Revenue Reports 筛选按钮功能
      function initializeRevenueReportsFilters() {
        // 上方时间筛选器按钮 - 使用更具体的选择器
        const timeFilterButtons = document.querySelectorAll('#ad-reports .revenue-filter-container .btn-group .btn');

        timeFilterButtons.forEach(button => {
          button.addEventListener('click', function() {
            // 只移除同组按钮的active类
            timeFilterButtons.forEach(btn => btn.classList.remove('active'));

            // 为当前按钮添加active类
            this.classList.add('active');

            // 获取筛选类型并更新状态
            const filterType = this.textContent.trim();
            filterState.timeFilter = filterType;

            // 清除自定义日期范围输入框
            const customDateInput = document.getElementById('customDateRange');
            if (customDateInput) {
              customDateInput.value = '';
            }

            // 显示加载状态
            showRevenueLoadingState();

            // 调用API获取真实数据
            loadRevenueReportsData(filterType);
          });
        });

        // Revenue Trend 图表切换按钮 - 使用更具体的选择器
        const chartButtons = document.querySelectorAll('#ad-reports .card-header .btn-group-sm .btn');
        chartButtons.forEach(button => {
          button.addEventListener('click', function() {
            // 只移除同组按钮的active类
            chartButtons.forEach(btn => btn.classList.remove('active'));

            // 为当前按钮添加active类
            this.classList.add('active');

            // 更新图表筛选器状态，但不影响时间筛选器
            const chartType = this.textContent.trim();
            filterState.chartFilter = chartType;

            showToast('info', '{% trans "Switched to" %} ' + chartType + ' {% trans "chart" %}');

            // 保持时间筛选器的状态不变
            restoreTimeFilterState();
          });
        });

        // Export Report 按钮
        const exportBtn = document.querySelector('#ad-reports button[type="button"]:has(i.fa-download)');
        if (exportBtn) {
          exportBtn.addEventListener('click', function() {
            showToast('info', '{% trans "Exporting revenue report..." %}');
            // 这里可以添加实际的导出逻辑
          });
        }

        // Refresh Data 按钮
        const refreshBtn = document.querySelector('#ad-reports button[type="button"]:has(i.fa-sync-alt)');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', function() {
            const icon = this.querySelector('i');
            icon.classList.add('fa-spin');

            showToast('info', '{% trans "Refreshing revenue data..." %}');

            // 模拟刷新过程
            setTimeout(() => {
              icon.classList.remove('fa-spin');
              loadAdStatistics();
              showToast('success', '{% trans "Revenue data refreshed successfully" %}');
            }, 1500);
          });
        }
      }

      // 从API加载Revenue Reports数据
      function loadRevenueReportsData(filterType) {
        // 将前端显示的文本转换为API参数
        const periodMap = {
          'Today': 'today',
          'Yesterday': 'yesterday',
          'This Week': 'this_week',
          'This Month': 'this_month'
        };

        const period = periodMap[filterType] || 'today';

        fetch(`{% url "games:revenue_reports" %}?period=${period}`, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          hideRevenueLoadingState();
          if (data.status === 'success') {
            updateRevenueReportsData(data.data);
            showToast('success', '{% trans "Revenue data updated for" %} ' + filterType);
          } else {
            console.error('API returned error:', data.message);
            showToast('error', '{% trans "Failed to load revenue data" %}');
          }
        })
        .catch(error => {
          hideRevenueLoadingState();
          console.error('Error loading revenue reports:', error);
          showToast('error', '{% trans "Failed to load revenue data" %}');
        });
      }

      // 更新Revenue Reports数据显示
      function updateRevenueReportsData(data) {
        // 更新数据显示
        const revenueEl = document.getElementById('reportRevenue');
        const viewsEl = document.getElementById('reportViews');
        const clicksEl = document.getElementById('reportClicks');
        const ctrEl = document.getElementById('reportCTR');

        if (revenueEl) revenueEl.textContent = '$' + parseFloat(data.revenue).toFixed(2);
        if (viewsEl) viewsEl.textContent = formatNumber(data.views);
        if (clicksEl) clicksEl.textContent = formatNumber(data.clicks);
        if (ctrEl) ctrEl.textContent = parseFloat(data.ctr).toFixed(1) + '%';

        // 更新变化百分比
        const changeElements = document.querySelectorAll('#ad-reports .text-success, #ad-reports .text-danger');
        changeElements.forEach(el => {
          if (el.textContent.includes('%')) {
            const changeValue = data.change || '+0%';
            const isPositive = changeValue.startsWith('+');
            el.className = isPositive ? 'text-success' : 'text-danger';
            el.innerHTML = `<i class="fas fa-arrow-${isPositive ? 'up' : 'down'} me-1"></i> ${changeValue}`;
          }
        });
      }

      // 显示Revenue Reports加载状态
      function showRevenueLoadingState() {
        const cards = document.querySelectorAll('#ad-reports .card h3');
        cards.forEach(card => {
          card.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        });
      }

      // 隐藏Revenue Reports加载状态
      function hideRevenueLoadingState() {
        // 数据会在updateRevenueReportsData中更新，这里不需要额外操作
      }

      // 初始化自定义日期范围选择器
      function initializeDateRangePicker() {
        const dateRangeInput = document.getElementById('customDateRange');
        const dateRangeBtn = document.getElementById('dateRangeBtn');

        if (!dateRangeInput || !dateRangeBtn) return;

        // 创建日期选择器模态框
        createDateRangeModal();

        // 点击日历按钮打开日期选择器
        dateRangeBtn.addEventListener('click', function() {
          showDateRangeModal();
        });

        // 点击输入框也打开日期选择器
        dateRangeInput.addEventListener('click', function() {
          showDateRangeModal();
        });
      }

      // 创建日期范围选择模态框
      function createDateRangeModal() {
        // 检查是否已存在模态框
        if (document.getElementById('dateRangeModal')) return;

        const modalHTML = `
          <div class="modal fade" id="dateRangeModal" tabindex="-1" aria-labelledby="dateRangeModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="dateRangeModalLabel">{% trans "Select Date Range" %}</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row">
                    <div class="col-md-6">
                      <label for="startDate" class="form-label">{% trans "Start Date" %}</label>
                      <input type="date" class="form-control" id="startDate" required>
                    </div>
                    <div class="col-md-6">
                      <label for="endDate" class="form-label">{% trans "End Date" %}</label>
                      <input type="date" class="form-control" id="endDate" required>
                    </div>
                  </div>
                  <div class="mt-3">
                    <small class="text-muted">{% trans "Select a date range to view revenue data for that period." %}</small>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                  <button type="button" class="btn btn-primary" id="applyDateRange">{% trans "Apply" %}</button>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // 添加应用按钮事件
        document.getElementById('applyDateRange').addEventListener('click', applyDateRange);
      }

      // 显示日期范围选择模态框
      function showDateRangeModal() {
        const modal = new bootstrap.Modal(document.getElementById('dateRangeModal'));

        // 设置默认日期（最近7天）
        const today = new Date();
        const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

        document.getElementById('startDate').value = formatDateForInput(weekAgo);
        document.getElementById('endDate').value = formatDateForInput(today);

        modal.show();
      }

      // 应用日期范围
      function applyDateRange() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (!startDate || !endDate) {
          showToast('error', '{% trans "Please select both start and end dates" %}');
          return;
        }

        if (new Date(startDate) > new Date(endDate)) {
          showToast('error', '{% trans "Start date cannot be later than end date" %}');
          return;
        }

        // 更新输入框显示
        const dateRangeInput = document.getElementById('customDateRange');
        dateRangeInput.value = `${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}`;

        // 清除时间筛选器按钮的active状态（不影响图表筛选器）
        const timeFilterButtons = document.querySelectorAll('#ad-reports .revenue-filter-container .btn-group .btn');
        timeFilterButtons.forEach(btn => btn.classList.remove('active'));

        // 关闭模态框
        const modal = bootstrap.Modal.getInstance(document.getElementById('dateRangeModal'));
        modal.hide();

        // 显示加载状态
        showRevenueLoadingState();

        // 调用API获取自定义日期范围的数据
        loadCustomDateRangeData(startDate, endDate);
      }

      // 加载自定义日期范围数据
      function loadCustomDateRangeData(startDate, endDate) {
        fetch(`{% url "games:revenue_reports" %}?start_date=${startDate}&end_date=${endDate}`, {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
          },
          credentials: 'same-origin'
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          hideRevenueLoadingState();
          if (data.status === 'success') {
            updateRevenueReportsData(data.data);
            showToast('success', '{% trans "Revenue data updated for custom date range" %}');
          } else {
            console.error('API returned error:', data.message);
            showToast('error', '{% trans "Failed to load revenue data" %}');
          }
        })
        .catch(error => {
          hideRevenueLoadingState();
          console.error('Error loading custom date range data:', error);
          showToast('error', '{% trans "Failed to load revenue data" %}');
        });
      }

      // 格式化日期为输入框格式 (YYYY-MM-DD)
      function formatDateForInput(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      // 格式化日期为显示格式
      function formatDateDisplay(dateStr) {
        const date = new Date(dateStr);
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }

      // 恢复时间筛选器状态的函数
      function restoreTimeFilterState() {
        const timeFilterButtons = document.querySelectorAll('#ad-reports .revenue-filter-container .btn-group .btn');
        timeFilterButtons.forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.trim() === filterState.timeFilter) {
            btn.classList.add('active');
          }
        });
      }

      // 恢复图表筛选器状态的函数
      function restoreChartFilterState() {
        const chartButtons = document.querySelectorAll('#ad-reports .card-header .btn-group-sm .btn');
        chartButtons.forEach(btn => {
          btn.classList.remove('active');
          if (btn.textContent.trim() === filterState.chartFilter) {
            btn.classList.add('active');
          }
        });
      }

      // 初始化Revenue Reports筛选功能
      initializeRevenueReportsFilters();

      // 初始化自定义日期范围选择器
      initializeDateRangePicker();

      // 初始化筛选器状态
      setTimeout(() => {
        restoreTimeFilterState();
        restoreChartFilterState();
      }, 100);

      // 状态切换功能
      const activeStatusToggles = document.querySelectorAll('.active-status-toggle');
      activeStatusToggles.forEach(toggle => {
        toggle.addEventListener('click', function() {
          const adId = this.getAttribute('data-id');
          const isActive = this.classList.contains('badge-active');

          // 发送AJAX请求更新状态
          fetch('{% url "games:toggle_ad_status" 0 %}'.replace('0', adId), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ is_active: !isActive })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // 更新UI状态
              if (data.is_active) {
                this.classList.remove('badge-inactive');
                this.classList.add('badge-active');
                this.textContent = '{% trans "Active" %}';
              } else {
                this.classList.remove('badge-active');
                this.classList.add('badge-inactive');
                this.textContent = '{% trans "Paused" %}';
              }

              // 更新对应的切换按钮图标
              const toggleBtn = document.querySelector(`.toggleStatusBtn[data-id="${adId}"]`);
              if (toggleBtn) {
                if (data.is_active) {
                  toggleBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                  toggleBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
              }

              showToast('success', data.message);
              loadAdStatistics(); // 重新加载统计数据
            } else {
              showToast('danger', data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('danger', '{% trans "An error occurred while processing your request" %}');
          });
        });
      });

      // 切换状态按钮功能
      const toggleStatusBtns = document.querySelectorAll('.toggleStatusBtn');
      toggleStatusBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const adId = this.getAttribute('data-id');
          const statusBadge = document.querySelector(`.active-status-toggle[data-id="${adId}"]`);
          if (statusBadge) {
            statusBadge.click(); // 触发状态切换
          }
        });
      });
      
      // 编辑广告模态框
      const editBtns = document.querySelectorAll('[data-bs-target="#editGoogleAdModal"]');
      editBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const adId = this.getAttribute('data-id');
          loadAdDataForEdit(adId);
        });
      });

      // 加载广告数据到编辑模态框
      function loadAdDataForEdit(adId) {
        // 从表格行中获取数据
        const row = document.querySelector(`button[data-id="${adId}"]`).closest('tr');
        const cells = row.querySelectorAll('td');

        // 提取数据
        const adName = cells[1].querySelector('strong').textContent;
        const adUnitId = cells[2].querySelector('small').textContent;
        const adType = cells[3].textContent.trim();
        const adSize = cells[4].textContent.trim();
        const position = cells[5].querySelector('span').textContent.trim();
        const views = cells[6].textContent.replace(/,/g, '');
        const ctr = cells[7].textContent.replace('%', '');
        const isActive = cells[9].querySelector('.badge').classList.contains('badge-active');

        // 填充表单
        document.getElementById('editAdUnitName').value = adName;
        document.getElementById('editAdUnitId').value = adUnitId === '-' ? '' : adUnitId;

        // 设置广告类型
        const typeSelect = document.getElementById('editAdUnitType');
        const typeMapping = {
          'Display Ad': 'display',
          'Text Ad': 'text',
          'Native Ad': 'native',
          'Interstitial Ad': 'interstitial',
          'Video Ad': 'video'
        };
        typeSelect.value = typeMapping[adType] || 'display';

        // 设置广告尺寸
        const sizeSelect = document.getElementById('editAdUnitSize');
        if (adSize === 'Responsive') {
          sizeSelect.value = 'responsive';
        } else if (adSize.includes('728 x 90')) {
          sizeSelect.value = '728x90';
        } else if (adSize.includes('300 x 250')) {
          sizeSelect.value = '300x250';
        } else if (adSize.includes('320 x 50')) {
          sizeSelect.value = '320x50';
        } else if (adSize.includes('300 x 600')) {
          sizeSelect.value = '300x600';
        } else if (adSize.includes('970 x 250')) {
          sizeSelect.value = '970x250';
        } else if (adSize.includes('320 x 480')) {
          sizeSelect.value = '320x480';
        } else {
          sizeSelect.value = 'custom';
        }

        // 设置位置
        const positionSelect = document.getElementById('editAdUnitPosition');
        const positionMapping = {
          'Page Header': 'header',
          'Sidebar': 'sidebar',
          'Game Interstitial': 'game_between',
          'Footer': 'footer'
        };
        positionSelect.value = positionMapping[position] || 'sidebar';

        // 设置状态
        document.getElementById('editAdStatus').value = isActive ? '1' : '0';

        // 设置统计数据
        document.getElementById('editAdViews').textContent = views;
        const clicks = Math.round(parseFloat(views.replace(/,/g, '')) * parseFloat(ctr) / 100);
        document.getElementById('editAdClicks').textContent = clicks.toLocaleString();
        document.getElementById('editAdCTR').textContent = ctr + '%';

        // 设置表单action
        const form = document.getElementById('editGoogleAdForm');
        form.setAttribute('data-ad-id', adId);
      }

      // 处理添加广告位置表单提交
      const addPlacementForm = document.getElementById('addPlacementForm');
      if (addPlacementForm) {
        addPlacementForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const formData = new FormData(this);

          // 显示加载状态
          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> {% trans "Adding..." %}';
          submitBtn.disabled = true;

          // 模拟添加广告位置（实际项目中应该发送到后端）
          setTimeout(() => {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('addPlacementModal'));
            modal.hide();

            // 重置表单
            this.reset();

            // 显示成功消息
            showToast('success', '{% trans "Ad placement added successfully" %}');

            // 恢复按钮状态
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;

            // 可以在这里添加刷新页面或更新UI的逻辑
            // location.reload(); // 如果需要刷新页面
          }, 1000);
        });
      }

      // 处理编辑表单提交
      const editForm = document.getElementById('editGoogleAdForm');
      if (editForm) {
        editForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const adId = this.getAttribute('data-ad-id');
          const formData = new FormData(this);

          // 显示加载状态
          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> {% trans "Saving..." %}';
          submitBtn.disabled = true;

          // 发送AJAX请求
          fetch('{% url "games:edit_ad_ajax" 0 %}'.replace('0', adId), {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
          .then(response => {
            if (response.ok) {
              return response.json();
            }
            throw new Error('Network response was not ok');
          })
          .then(data => {
            if (data.success) {
              // 更新表格中的数据
              updateTableRow(adId, formData);

              // 关闭模态框
              const modal = bootstrap.Modal.getInstance(document.getElementById('editGoogleAdModal'));
              modal.hide();

              showToast('success', '{% trans "Ad unit updated successfully" %}');
              loadAdStatistics(); // 重新加载统计数据
            } else {
              showToast('danger', data.message || '{% trans "Failed to update ad unit" %}');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('danger', '{% trans "An error occurred while updating the ad unit" %}');
          })
          .finally(() => {
            // 恢复按钮状态
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          });
        });
      }

      // 编辑广告位置按钮事件处理
      const editPlacementBtns = document.querySelectorAll('.edit-placement-btn');
      editPlacementBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const placement = this.getAttribute('data-placement');
          loadPlacementDataForEdit(placement);
        });
      });

      // 显示广告位置代码按钮事件处理
      const showPlacementCodeBtns = document.querySelectorAll('.show-placement-code-btn');
      showPlacementCodeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
          const placement = this.getAttribute('data-placement');
          showPlacementCode(placement);
        });
      });

      // 处理编辑广告位置表单提交
      const editPlacementForm = document.getElementById('editPlacementForm');
      if (editPlacementForm) {
        editPlacementForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const placement = this.getAttribute('data-placement');
          const formData = new FormData(this);

          // 显示加载状态
          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> {% trans "Saving..." %}';
          submitBtn.disabled = true;

          // 模拟保存过程（实际项目中应该发送到后端）
          setTimeout(() => {
            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editPlacementModal'));
            modal.hide();

            showToast('success', '{% trans "Ad placement updated successfully" %}');

            // 恢复按钮状态
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;

            // 可以在这里添加更新UI的逻辑
          }, 1000);
        });
      }

      // 更新表格行数据
      function updateTableRow(adId, formData) {
        const row = document.querySelector(`button[data-id="${adId}"]`).closest('tr');
        const cells = row.querySelectorAll('td');

        // 更新广告名称
        const nameCell = cells[1];
        const nameLink = nameCell.querySelector('strong');
        nameLink.textContent = formData.get('name');

        // 更新广告单元ID
        const idCell = cells[2];
        const idElement = idCell.querySelector('small');
        const unitId = formData.get('adsense_unit_id');
        idElement.textContent = unitId || '-';

        // 更新广告类型
        const typeCell = cells[3];
        const typeMapping = {
          'display': '{% trans "Display Ad" %}',
          'text': '{% trans "Text Ad" %}',
          'native': '{% trans "Native Ad" %}',
          'interstitial': '{% trans "Interstitial Ad" %}',
          'video': '{% trans "Video Ad" %}'
        };
        typeCell.textContent = typeMapping[formData.get('ad_type')] || '{% trans "Display Ad" %}';

        // 更新广告尺寸
        const sizeCell = cells[4];
        const sizeMapping = {
          'responsive': '{% trans "Responsive" %}',
          '728x90': '728 x 90 (Lead…',
          '300x250': '300 x 250 (Med…',
          '320x50': '320 x 50 (Mobi…',
          '300x600': '300 x 600 (Hal…',
          '970x250': '970 x 250 (Bil…',
          '320x480': '320 x 480 (Mob…',
          'custom': '{% trans "Custom Size" %}'
        };
        sizeCell.textContent = sizeMapping[formData.get('ad_size')] || '{% trans "Responsive" %}';

        // 更新位置
        const positionCell = cells[5];
        const positionBadge = positionCell.querySelector('span');
        const positionMapping = {
          'header': '{% trans "Page Header" %}',
          'sidebar': '{% trans "Sidebar" %}',
          'game_between': '{% trans "Game Interstitial" %}',
          'footer': '{% trans "Footer" %}'
        };
        positionBadge.textContent = positionMapping[formData.get('position')] || '{% trans "Sidebar" %}';

        // 更新状态
        const statusCell = cells[9];
        const statusBadge = statusCell.querySelector('.badge');
        const isActive = formData.get('is_active') === '1';

        if (isActive) {
          statusBadge.classList.remove('badge-inactive');
          statusBadge.classList.add('badge-active');
          statusBadge.textContent = '{% trans "Active" %}';
        } else {
          statusBadge.classList.remove('badge-active');
          statusBadge.classList.add('badge-inactive');
          statusBadge.textContent = '{% trans "Paused" %}';
        }

        // 更新操作按钮中的状态切换图标
        const actionCell = cells[10];
        const toggleBtn = actionCell.querySelector('.toggleStatusBtn');
        if (toggleBtn) {
          if (isActive) {
            toggleBtn.innerHTML = '<i class="fas fa-pause"></i>';
          } else {
            toggleBtn.innerHTML = '<i class="fas fa-play"></i>';
          }
        }
      }

      // 显示广告代码功能
      window.showAdCode = function(adId) {
        // 这里可以通过AJAX获取广告代码，现在先显示示例
        const adCodeContent = document.getElementById('adCodeContent');
        const adCode = `<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"><\/script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"
     data-ad-slot="XXXXXXXXXX"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
<\/script>`;

        adCodeContent.textContent = adCode;

        const adCodeModal = new bootstrap.Modal(document.getElementById('adCodeModal'));
        adCodeModal.show();
      };

      // 复制广告代码功能
      window.copyAdCode = function() {
        const adCodeContent = document.getElementById('adCodeContent');
        const textArea = document.createElement('textarea');
        textArea.value = adCodeContent.textContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('success', '{% trans "Ad code copied to clipboard" %}');
      };

      // 复制广告位置代码功能
      window.copyPlacementCode = function() {
        const placementCodeContent = document.getElementById('placementCodeContent');
        const textArea = document.createElement('textarea');
        textArea.value = placementCodeContent.textContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('success', '{% trans "Placement code copied to clipboard" %}');
      };

      // 加载广告位置数据到编辑模态框
      function loadPlacementDataForEdit(placement) {
        const placementData = {
          'header': {
            name: '{% trans "Page Header Banner" %}',
            position: 'header',
            size: '728x90',
            maxAds: 2,
            description: '{% trans "Displayed at the top of all website pages" %}'
          },
          'sidebar': {
            name: '{% trans "Sidebar Ad Space" %}',
            position: 'sidebar',
            size: '300x250',
            maxAds: 3,
            description: '{% trans "Displayed in the website sidebar area" %}'
          },
          'game_between': {
            name: '{% trans "Game Interstitial Ad" %}',
            position: 'game_between',
            size: '320x480',
            maxAds: 1,
            description: '{% trans "Full-screen ads displayed during game loading or between games" %}'
          }
        };

        const data = placementData[placement];
        if (data) {
          document.getElementById('editPlacementName').value = data.name;
          document.getElementById('editPlacementPosition').value = data.position;
          document.getElementById('editPlacementSize').value = data.size;
          document.getElementById('editPlacementMaxAds').value = data.maxAds;
          document.getElementById('editPlacementDescription').value = data.description;
          document.getElementById('editPlacementActive').checked = true;

          // 设置表单的数据属性
          const form = document.getElementById('editPlacementForm');
          form.setAttribute('data-placement', placement);
        }
      }

      // Show ad placement code
      function showPlacementCode(placement) {
        const placementCodes = {
          'header': '<!-- {% trans "Header Ad Placement" %} -->\n' +
'<div class="ad-placement-header">\n' +
'  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"><\/script>\n' +
'  <ins class="adsbygoogle"\n' +
'       style="display:block"\n' +
'       data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"\n' +
'       data-ad-slot="XXXXXXXXXX"\n' +
'       data-ad-format="auto"\n' +
'       data-full-width-responsive="true"></ins>\n' +
'  <script>\n' +
'       (adsbygoogle = window.adsbygoogle || []).push({});\n' +
'  <\/script>\n' +
'</div>',
          'sidebar': '<!-- {% trans "Sidebar Ad Placement" %} -->\n' +
'<div class="ad-placement-sidebar">\n' +
'  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"><\/script>\n' +
'  <ins class="adsbygoogle"\n' +
'       style="display:block"\n' +
'       data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"\n' +
'       data-ad-slot="XXXXXXXXXX"\n' +
'       data-ad-format="rectangle"></ins>\n' +
'  <script>\n' +
'       (adsbygoogle = window.adsbygoogle || []).push({});\n' +
'  <\/script>\n' +
'</div>',
          'game_between': '<!-- {% trans "Game Interstitial Ad Placement" %} -->\n' +
'<div class="ad-placement-interstitial">\n' +
'  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-XXXXXXXXXXXXXXXX" crossorigin="anonymous"><\/script>\n' +
'  <ins class="adsbygoogle"\n' +
'       style="display:block"\n' +
'       data-ad-client="ca-pub-XXXXXXXXXXXXXXXX"\n' +
'       data-ad-slot="XXXXXXXXXX"\n' +
'       data-ad-format="interstitial"\n' +
'       data-full-width-responsive="true"></ins>\n' +
'  <script>\n' +
'       (adsbygoogle = window.adsbygoogle || []).push({});\n' +
'  <\/script>\n' +
'</div>'
        };

        const code = placementCodes[placement];
        if (code) {
          const placementCodeContent = document.getElementById('placementCodeContent');
          placementCodeContent.textContent = code;

          const placementCodeModal = new bootstrap.Modal(document.getElementById('placementCodeModal'));
          placementCodeModal.show();
        }
      }

      // Get CSRF Token
      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
      
      // Show notification message
      function showToast(type, message) {
        const toastContainer = document.querySelector('.toast-container') || (() => {
          const container = document.createElement('div');
          container.className = 'toast-container position-fixed top-0 end-0 p-3';
          container.style.zIndex = '9999';
          document.body.appendChild(container);
          return container;
        })();

        const toast = document.createElement('div');
        toast.className = `toast show`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');

        const bgClass = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-info';

        toast.innerHTML = `
          <div class="toast-header ${bgClass} text-white">
            <strong class="me-auto">{% trans 'Notification' %}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        `;

        toastContainer.appendChild(toast);

        // Create Bootstrap Toast instance and show
        const bsToast = new bootstrap.Toast(toast, {
          autohide: true,
          delay: 3000
        });
        bsToast.show();

        // Remove after 3 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 3500);
      }

      // Copy text to clipboard
      function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
          // Use modern Clipboard API
          navigator.clipboard.writeText(text).then(function() {
            showToast('success', '{% trans "Copied to clipboard" %}');
          }).catch(function(err) {
            console.error('Failed to copy: ', err);
            showToast('danger', '{% trans "Failed to copy to clipboard" %}');
          });
        } else {
          // Fallback to traditional method
          const textArea = document.createElement('textarea');
          textArea.value = text;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();

          try {
            const successful = document.execCommand('copy');
            if (successful) {
              showToast('success', '{% trans "Copied to clipboard" %}');
            } else {
              showToast('danger', '{% trans "Failed to copy to clipboard" %}');
            }
          } catch (err) {
            console.error('Failed to copy: ', err);
            showToast('danger', '{% trans "Failed to copy to clipboard" %}');
          } finally {
            document.body.removeChild(textArea);
          }
        }
      }

      // AdSense settings edit functionality
      function toggleAdSenseEdit() {
        const displayMode = document.getElementById('adsense-display-mode');
        const editMode = document.getElementById('adsense-edit-mode');
        const editBtn = document.getElementById('editAdSenseBtn');

        if (editMode.style.display === 'none') {
          // Switch to edit mode
          displayMode.style.display = 'none';
          editMode.style.display = 'block';
          editBtn.innerHTML = '<i class="fas fa-times me-1"></i> {% trans "Cancel" %}';
          editBtn.className = 'btn btn-outline-secondary btn-sm';
        } else {
          // Switch to display mode
          displayMode.style.display = 'block';
          editMode.style.display = 'none';
          editBtn.innerHTML = '<i class="fas fa-edit me-1"></i> {% trans "Edit Settings" %}';
          editBtn.className = 'btn btn-outline-primary btn-sm';
        }
      }

      function cancelAdSenseEdit() {
        toggleAdSenseEdit();
      }

      // Add edit button event listener
      const editAdSenseBtn = document.getElementById('editAdSenseBtn');
      if (editAdSenseBtn) {
        editAdSenseBtn.addEventListener('click', toggleAdSenseEdit);
      }

      // Add cancel button event listener
      const cancelAdSenseBtn = document.getElementById('cancelAdSenseBtn');
      if (cancelAdSenseBtn) {
        cancelAdSenseBtn.addEventListener('click', cancelAdSenseEdit);
      }

      // Handle AdSense settings form submission
      const adsenseForm = document.getElementById('adsenseSettingsForm');
      if (adsenseForm) {
        adsenseForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const formData = new FormData(this);
          const submitBtn = this.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;

          // Show loading state
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> {% trans "Saving..." %}';
          submitBtn.disabled = true;

          fetch(this.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': getCookie('csrftoken')
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('success', data.message || '{% trans "AdSense settings updated successfully" %}');
              // Refresh page to show updated status
              setTimeout(() => {
                window.location.reload();
              }, 1000);
            } else {
              showToast('danger', data.message || '{% trans "Failed to update AdSense settings" %}');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            showToast('danger', '{% trans "An error occurred while updating settings" %}');
          })
          .finally(() => {
            // Restore button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          });
        });
      }

      // AdSense settings are handled on the backend, only need to handle copy functionality here
      function copyToClipboard(text) {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).then(function() {
            showToast('success', '{% trans "Publisher ID copied to clipboard" %}');
          }).catch(function(err) {
            console.error('Failed to copy: ', err);
            showToast('danger', '{% trans "Failed to copy to clipboard" %}');
          });
        } else {
          // Fallback: use traditional copy method
          const textArea = document.createElement('textarea');
          textArea.value = text;
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          try {
            document.execCommand('copy');
            showToast('success', '{% trans "Publisher ID copied to clipboard" %}');
          } catch (err) {
            console.error('Failed to copy: ', err);
            showToast('danger', '{% trans "Failed to copy to clipboard" %}');
          }
          document.body.removeChild(textArea);
        }
      }

      // AdSense connection verification function
      window.verifyAdSenseConnection = function() {
        const publisherId = document.getElementById('adsense-publisher-id-input').value;
        const verifyBtn = document.getElementById('verify-adsense-btn');
        const statusDiv = document.getElementById('verification-status');
        const loadingDiv = document.getElementById('verification-loading');
        const successDiv = document.getElementById('verification-success');
        const errorDiv = document.getElementById('verification-error');

        // Reset status
        statusDiv.style.display = 'block';
        loadingDiv.style.display = 'block';
        successDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        // Disable verification button
        verifyBtn.disabled = true;
        verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> {% trans "Verifying..." %}';

        // Send verification request
        fetch('{% url "admin:verify_adsense_connection" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            publisher_id: publisherId
          })
        })
        .then(response => response.json())
        .then(data => {
          loadingDiv.style.display = 'none';

          if (data.success && data.status === 'verified') {
            // Verification successful
            successDiv.style.display = 'block';
            document.getElementById('verification-success-message').textContent = data.message;

            // Update account status
            const accountStatusInput = document.getElementById('account-status-input');
            const accountStatusText = document.getElementById('account-status-text');
            accountStatusInput.value = '{% trans "Verified & Active" %}';
            accountStatusText.textContent = data.message;

            // If account info exists, show payment information
            if (data.account_info) {
              const paymentSection = document.getElementById('payment-info-section');
              const paymentSuccess = document.getElementById('payment-success');
              if (paymentSuccess) {
                paymentSuccess.innerHTML = '<i class="fas fa-check-circle me-2"></i> {% trans "Your payment information has been set up. Next payment date: " %}' + data.account_info.next_payment;
              }
            }

            // Hide success message after 5 seconds
            setTimeout(() => {
              statusDiv.style.display = 'none';
            }, 5000);

          } else {
            // Verification failed
            errorDiv.style.display = 'block';
            document.getElementById('verification-error-message').textContent = data.message;

            // If suggestions exist, show suggestion list
            if (data.suggestions && data.suggestions.length > 0) {
              let suggestionHtml = data.message + '<br><small>{% trans "Suggestions:" %}<ul>';
              data.suggestions.forEach(suggestion => {
                suggestionHtml += '<li>' + suggestion + '</li>';
              });
              suggestionHtml += '</ul></small>';
              document.getElementById('verification-error-message').innerHTML = suggestionHtml;
            }
          }
        })
        .catch(error => {
          console.error('Verification error:', error);
          loadingDiv.style.display = 'none';
          errorDiv.style.display = 'block';
          document.getElementById('verification-error-message').textContent = '{% trans "Network error occurred during verification. Please try again." %}';
        })
        .finally(() => {
          // Re-enable verification button
          verifyBtn.disabled = false;
          verifyBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> {% trans "Verify Connection" %}';
        });
      };
    });
  </script>
{% endblock %}